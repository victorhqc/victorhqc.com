name: Pull Request

on:
    push:
        branches:
            - main
    pull_request:

jobs:
    rust_check:
        name: Rust Check
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                os: [ ubuntu-latest ]
                rust: [ stable ]
        steps:
            -   uses: actions/checkout@v3

            -   name: Install latest stable
                uses: actions-rs/toolchain@v1
                with:
                    toolchain: stable
                    override: true
                    components: rustfmt, clippy

            -   uses: Swatinem/rust-cache@v1

            -   name: Generate Cargo.lock
                uses: actions-rs/cargo@v1
                with:
                    command: generate-lockfile

            -   name: Install SQLX
                run: |
                    cargo install sqlx-cli --no-default-features --features sqlite

            -   name: Init DB
                run: |
                    cd api
                    sqlx db setup
                env:
                    DATABASE_URL: sqlite://github.db

            - name: Build API
              run: |
                  cd api
                  cp .env.example .env
                  cargo build

            -   name: Run cargo check
                uses: actions-rs/cargo@v1
                with:
                    command: check

            -   name: Run cargo fmt
                uses: actions-rs/cargo@v1
                with:
                    command: fmt
                    args: --all --check

            -   name: Run cargo clippy
                uses: actions-rs/cargo@v1
                with:
                    command: clippy
                    args: -- -D warnings
